title User onboarding to first Issuer

Participant User
Participant DAA
Participant Cloud Agent
Participant Issuer
Participant DAS
Participant ARD


User -> Issuer: I want a Digital Address\n(Authentication + accept T&C)\n Issuer has ID-proofed user before
Issuer -> Issuer: Lookup ID-Attribs for that user in Issuer DB
Issuer -> Issuer: DA-001: Compute HIDA = hash (ID-Attribs)
Issuer ->> DAS: DR-001: Securely send HIDA, ISSUER_ID \nand request Digital Address
DAS ->> ARD: DR-001: Lookup TA_USER_ISSUER for HIDA, ISSUER_ID
ARD -> ARD: DR-001: Lookup TA for HIDA

alt TA not found
ARD -> ARD: Generate TA = random
else TA found
note over ARD
Enroll a User with existing Digital Address
end note
end

ARD -->> DAS: DA-001:No conflict with TA.\n Return TA_USER_ISSUER = hash (TA, ISSUER_ID), HomeDAS=DAS_ID
DAS->>DAS: DA-003:Provision a Cloud Agent for User with HIDA
DAS->Cloud Agent: DA-003:Request to Create DAS_USER_ID for HIDA
Cloud Agent ->Cloud Agent: DA-003:Create DAS_USER_ID & DAS_USER_ID_PK/SK\n Create DIDDoc
Cloud Agent-->>DAS: DA-003:Send [DAS_USER_ID, DAS_USER_ID_PK] to DAS
DAS->DAS: DA-003:Store User DIDDoc
DAS->>Cloud Agent: DA-003: DID Doc save success
DAS -> DAS: DA-004:Create DA.\n Store [DA, TA_USER_ISSUER, DAS_USER_ID, DAS_USER_ID_PK]
DAS ->> ARD: DA-004:Send [DAS_USER_ID, HIDA, HomeDAS_ID] to notify about DA
ARD -> ARD: DA-004:store [HIDA, TA]\n [TA, DAS_USER_ID, HomeDAS_ID=DAS_ID]
ARD -->> DAS: DA-004:Success
DAS --> Issuer: DA-004:Return DAS_USER_ID
Issuer -> Issuer: Remember DAS_USER_ID for user in Issuer DB
Issuer -> Issuer: Creates QR code (DAS_USER_ID, IssuerConnectionURL)
Issuer -> User: Present QR (Ex: Console) or send QR (Ex: Email)
User -> DAA: Scan the QR code and \nextract [DAS_USER_ID, IssuerConnectionURL]
DAA -> DAA: Start ID proofing on the device \nand extract the User info
DAA->DAS: Send Verified User Attributes +\n DAS_USER_ID to IssuerConnectionURL
DAS->>Issuer: DR-001:Verify User [DAS_USER_ID, User Attributes]
Issuer ->> Issuer: Verify User Attributes against \nIssuer DB [DAS_USER_ID, User Attributes]
Issuer-->>DAS: DR-001:Verification Status [DAS_USER_ID, Success/Failure]
DAS --> DAA: DR-001:Verification status [DAS_USER_ID, DA, Validation Success/Failure]
DAA -> DAA: If successful: Remember DAS_USER_ID, DA
DAA -> DAS: Register FIDO Authenticator for new device\n [DAS_USER_ID, USER_FIDO_PK]
DAS-> DAS: Remember (USER_FIDO_PK, DAS_USER_ID)
DAS --> DAA: Acknowledge successful FIDO registration
DAA-->User: Digital Address enrolled and ready for use
