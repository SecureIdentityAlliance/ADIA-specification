title Enroll an Issuer to DAS
actor Issuer Admin
participant Issuer
participant DAS
actor DAS Admin
participant ARD
participant AGD

Issuer Admin -> DAS: Primary contact and Org details
DAS->DAS: Save Request [Status=NEW]. Generate REQUEST_ID
DAS->Issuer Admin:Request Reference\n[REQUEST_ID, Status=New]
DAS Admin->DAS: Review Pending Request [REQUEST_ID]
DAS->DAS: lookup ID-attributes for the entity \nand compute HIDA = hash (ID-attributes)
DAS->ARD: securely send \n[HIDA,DAS_ID, CorrelationId=REQUEST_ID] \nand request DA
ARD->AGD: lookup TA_ENTITY_DAS for [HIDA, DAS_ID]
AGD->AGD: lookup TA for HIDA
alt
AGD->AGD: Generate TA = random
end
AGD->ARD: No conflict with TA\nReturn TA_ENTITY_DAS = hash[TA,DAS_ID]
ARD->DAS: Approve [REQUEST_ID]
DAS->DAS: Create [DAS_ENTITY_ID, ENTITY_TYPE]
DAS->DAS: Provision Issuer Agent for Issuer\n with HIDA [CorrelationId=REQUEST_ID]
alt DAS provides agency services
DAS->Issuer: Generate DAS_ENTITY_ID_PK/SK for [DAS_ENTITY_ID]
Issuer->DAS: Send [DAS_ENTITY_ID,ENTITY_TYPE, DAS_ENTITY_ID_PK/SK]
else Issuer hosts agent
DAS->Issuer Admin: Generate Keys and enroll
Issuer Admin->Issuer: Generate DAS_ENTITY_ID_PK/SK for DAS_ENTITY_ID
Issuer->DAS: Send [DAS_ENTITY_ID,DAS_ENTITY_ID_PK]
end
DAS->DAS: Create DA and \nStore [DAS_ENTITY_ID,ENTITY_TYPE, DA, DAS_ENTITY_ID_PK,REQUEST_ID]
opt Approve Request [REQUEST_ID]
DAS Admin->DAS: Approve Request [REQUEST_ID]
DAS->ARD: Send [DAS_ENTITY_ID,ENTITY_TYPE, DAS_ENTITY_ID_PK,CorrelationId=REQUEST_ID]
ARD->AGD: Forward Request [DAS_ENTITY_ID,ENTITY_TYPE, DAS_ENTITY_ID_PK]
AGD->AGD: Store [TA,DAS_ENTITY_ID, ENTITY_TYPE, HomeDAS_ID=DAS_ID] \nand [DAS_ENTITY_ID,DAS_ENTITY_ID_PK]
AGD-->ARD: Success
end
ARD-->DAS:Store [REQUEST_ID,DAS_ENTITY_ID,ENTITY_TYPE, DA]
DAS->DAS: Request Complete [REQUEST_ID, Status=APPROVED]
DAS-->Issuer: Issuer provisioning complete [REQUEST_ID, Status=APPROVED]
